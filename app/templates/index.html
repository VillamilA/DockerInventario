<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center text-primary mb-4">Gesti√≥n de Inventario</h1>

    <!-- üîê LOGIN -->
    <div class="card mb-4" id="login-section">
      <div class="card-body">
        <h4 class="card-title">Inicio de Sesi√≥n</h4>
        <div class="row g-3">
          <div class="col-md-5">
            <input id="username" class="form-control" type="text" placeholder="Usuario" />
          </div>
          <div class="col-md-5">
            <input id="password" class="form-control" type="password" placeholder="Contrase√±a" />
          </div>
          <div class="col-md-2">
            <button onclick="iniciarSesion()" class="btn btn-primary w-100">Ingresar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ CONSULTA DISPONIBILIDAD -->
    <div class="card mb-4 d-none" id="consulta-section">
      <div class="card-body">
        <h4 class="card-title">Consultar Disponibilidad</h4>
        <div class="input-group">
          <input id="consulta-codigo" type="text" class="form-control" placeholder="C√≥digo del producto" />
          <button onclick="consultarDisponibilidad()" class="btn btn-outline-info">Consultar</button>
        </div>
        <div id="resultado-consulta" class="mt-3 text-success fw-bold"></div>
      </div>
    </div>

    <!-- üìù FORMULARIO PRODUCTOS -->
    <div class="card mb-4 d-none" id="formulario-section">
      <div class="card-body">
        <h4 class="card-title">Registrar / Editar Producto</h4>
        <div class="row g-3">
          <input type="hidden" id="id-editar" />
          <div class="col-md-4">
            <input id="nombre" class="form-control" type="text" placeholder="Nombre" />
          </div>
          <div class="col-md-4">
            <input id="codigo" class="form-control" type="text" placeholder="C√≥digo" />
          </div>
          <div class="col-md-4">
            <input id="descripcion" class="form-control" type="text" placeholder="Descripci√≥n" />
          </div>
          <div class="col-md-4">
            <input id="unidad" class="form-control" type="text" placeholder="Unidad" />
          </div>
          <div class="col-md-4">
            <input id="categoria" class="form-control" type="text" placeholder="Categor√≠a" />
          </div>
          <div class="col-md-4 d-grid">
            <button onclick="guardarProducto()" class="btn btn-success">Guardar Producto</button>
          </div>
        </div>
      </div>
    </div>

    <!-- üì¶ TABLA PRODUCTOS -->
    <div class="card d-none" id="tabla-section">
      <div class="card-body">
        <h4 class="card-title">Lista de Productos</h4>
        <table class="table table-bordered table-striped mt-3">
          <thead class="table-primary">
            <tr>
              <th>Nombre</th>
              <th>C√≥digo</th>
              <th>Descripci√≥n</th>
              <th>Unidad</th>
              <th>Categor√≠a</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-productos"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- JS Bootstrap y l√≥gica interactiva -->
  <script>
    let sesionIniciada = false;

    function mostrarSecciones() {
      document.getElementById("login-section").classList.add("d-none");
      document.getElementById("formulario-section").classList.remove("d-none");
      document.getElementById("tabla-section").classList.remove("d-none");
      document.getElementById("consulta-section").classList.remove("d-none");
    }

    async function iniciarSesion() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
      });

      const data = await res.json();
      if (data.success) {
        alert("Login exitoso");
        sesionIniciada = true;
        mostrarSecciones();
        cargarProductos();
      } else {
        alert("Credenciales incorrectas");
      }
    }

    async function cargarProductos() {
      const res = await fetch("/productos");
      const productos = await res.json();
      const tabla = productos
        .map(
          (p) => `
        <tr>
          <td>${p.nombre}</td>
          <td>${p.codigo}</td>
          <td>${p.descripcion}</td>
          <td>${p.unidad}</td>
          <td>${p.categoria}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editarProducto(${p.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${p.id})">Eliminar</button>
          </td>
        </tr>
      `
        )
        .join("");
      document.getElementById("tabla-productos").innerHTML = tabla;
    }

    async function guardarProducto() {
      const id = document.getElementById("id-editar").value;
      const producto = {
        nombre: document.getElementById("nombre").value,
        codigo: document.getElementById("codigo").value,
        descripcion: document.getElementById("descripcion").value,
        unidad: document.getElementById("unidad").value,
        categoria: document.getElementById("categoria").value,
      };

      const url = id
        ? `/productos/${id}`
        : "/productos";
      const method = id ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(producto),
      });

      if (res.ok) {
        alert(id ? "Producto actualizado" : "Producto agregado");
        limpiarFormulario();
        cargarProductos();
      } else {
        const error = await res.json();
        alert("Error: " + error.error || error.message);
      }
    }

    async function editarProducto(id) {
      const res = await fetch("/productos");
      const productos = await res.json();
      const producto = productos.find((p) => p.id === id);
      document.getElementById("id-editar").value = producto.id;
      document.getElementById("nombre").value = producto.nombre;
      document.getElementById("codigo").value = producto.codigo;
      document.getElementById("descripcion").value = producto.descripcion;
      document.getElementById("unidad").value = producto.unidad;
      document.getElementById("categoria").value = producto.categoria;
    }

    async function eliminarProducto(id) {
      if (!confirm("¬øEliminar este producto?")) return;
      await fetch(`/productos/${id}`, { method: "DELETE" });
      alert("Producto eliminado");
      cargarProductos();
    }

    async function consultarDisponibilidad() {
      const codigo = document.getElementById("consulta-codigo").value.trim();
      if (!codigo) return;

      const res = await fetch(`/producto/${codigo}`);
      const resultado = document.getElementById("resultado-consulta");

      if (res.ok) {
        const p = await res.json();
        resultado.textContent = `Disponible: ${p.nombre} (${p.descripcion})`;
      } else {
        resultado.textContent = "Producto no encontrado.";
      }
    }

    function limpiarFormulario() {
      document.getElementById("id-editar").value = "";
      document.getElementById("nombre").value = "";
      document.getElementById("codigo").value = "";
      document.getElementById("descripcion").value = "";
      document.getElementById("unidad").value = "";
      document.getElementById("categoria").value = "";
    }
  </script>
</body>
</html>
